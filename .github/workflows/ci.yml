name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-core:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: core
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run core tests
        run: cargo test --all-features

  test-proxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run proxy unit tests
        run: cargo test -p ratls-proxy
      - name: Run proxy integration tests
        run: cargo test -p ratls-proxy --test integration

  test-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Check WASM compilation
        run: cargo check -p ratls-wasm --target wasm32-unknown-unknown
      - name: Run WASM tests (Node.js)
        run: wasm-pack test --node wasm

  test-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install node dependencies
        working-directory: node
        run: pnpm install --frozen-lockfile
      - name: Build native module
        working-directory: node
        run: pnpm build
      - name: Run node tests
        working-directory: node
        run: npm test

  test-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@2ddd2b9cb38ad8efd50337e8ab201519a34c9f24 # v7

      - name: Install dependencies
        working-directory: python
        run: |
          uv sync --all-groups

      - name: Run python tests
        working-directory: python
        run: uv run pytest -v
