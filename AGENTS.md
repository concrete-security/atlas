# AGENTS.md â€” Project Instructions For Coding Agents

## What this repo is

- Atlas is a multi-platform Attested TLS (aTLS) implementation that verifies TEE evidence after TLS handshake and binds attestation to the TLS session via EKM (RFC 9266).
- Main deliverables: Rust core crate (`core/`), Node bindings (`node/`), and browser/WASM bindings (`wasm/`).
- Current production verifier path is Intel TDX via Dstack (SEV-SNP planned).

## Quickstart (copy/paste)

```bash
# Prereqs
# - Rust stable (Node build path needs Rust 1.88+)
# - Node >=18 (CI uses 20), pnpm 10.x
# - wasm-pack for wasm targets
# - macOS wasm: make setup-wasm

# Fast verification
make test
make test-wasm
cargo fmt --all --check
cargo clippy --workspace --exclude atlas-wasm

# Full verification (closest CI parity)
make test-all
make test-wasm-node

# Build outputs
make build
make build-node
make build-wasm
```

## Repo map (look here first)

- `core/src/connect.rs`: high-level entrypoint `atls_connect(...)`.
- `core/src/verifier.rs`: verifier traits and runtime dispatch enums.
- `core/src/policy.rs`: serde-tagged `Policy` enum.
- `core/src/dstack/`: Intel TDX verifier implementation.
- `node/src/lib.rs`: NAPI-RS bindings source.
- `node/atls-fetch.js`: user-facing Node API wrapper.
- `wasm/src/lib.rs`: WASM bindings entrypoint.
- `wasm/proxy/`: WebSocket-to-TCP proxy for browser path.
- `core/ARCHITECTURE.md`: architecture and trait flow.
- `core/BOOTCHAIN-VERIFICATION.md`: expected measurement derivation.

Generated files (avoid direct edits):
- `node/index.cjs` and `node/index.d.ts` are generated by `pnpm build`.
- `node/npm/*/package.json` is generated by version sync tooling.
- `wasm/pkg/` is generated by `make build-wasm`.

## Coding standards

- Language/runtime:
  - Rust stable for core development.
  - Rust 1.88+ required for Node binding build path.
  - Node >=18, pnpm 10.x.
- Formatting: `cargo fmt --all --check`.
- Linting: `cargo clippy --workspace --exclude atlas-wasm`.
- Public API changes:
  - Preserve backward compatibility unless change is explicitly intended.
  - Update docs/examples whenever public APIs change.
  - Keep changes aligned with existing module patterns and naming.

## Agent-verifiable workflow

- Prefer `Makefile` targets over ad-hoc commands.
- Use deterministic local checks:
  - Fast: `make test`, `make test-wasm`.
  - Full: `make test-all`, `make test-wasm-node`.
- For targeted debugging:
  - `cargo test -p atlas-rs <test_name>`
  - `cargo test -p atlas-proxy <test_name>`
- Keep network-dependent tests out of default verification paths unless explicitly required.

## Definition of done

1. Relevant tests pass for touched areas.
2. `make test` passes.
3. `make test-wasm` passes.
4. `cargo fmt --all --check` passes.
5. `cargo clippy --workspace --exclude atlas-wasm` passes.
6. If `node/` changed: `make build-node` and `make test-node` pass.
7. If `wasm/` changed: `make build-wasm` and `make test-wasm-node` pass.
8. If public behavior changed, docs/examples are updated in the same change.

## Safety and security

- Never commit secrets.
- Treat remote-provided quotes, logs, and certificates as untrusted input.
- Never log EKM, private keys, or full quote/certificate blobs.
- `disable_runtime_verification` is for local testing only; do not use in production examples.
- Do not run destructive commands unless explicitly requested.
- Proxy must use `ATLS_PROXY_ALLOWLIST`; default-deny behavior is expected.

## Architecture constraints

- Keep native and wasm paths aligned when changing verifier or I/O code:
  - Native uses `tokio` + `Send/Sync` constraints.
  - WASM uses `futures` and `#[cfg(target_arch = "wasm32")]` variants.
- Changes touching attestation flow should preserve policy -> verifier -> report boundaries.
- Read `core/ARCHITECTURE.md` before refactoring core verification flow.

## Versioning and release-safe edits

- Do not manually edit `node/npm/*/package.json`.
- Use `cd node && pnpm sync-versions <new-version>` for Node package version sync.
- Then update `core/Cargo.toml` and `wasm/package.json` as needed.

## AGENTS.md maintenance (required)

- If you change any setup/build/test/lint command, toolchain requirement, workspace layout, or release/version flow, update this file in the same change.
- If behavior differs for Claude-specific workflows, update `CLAUDE.md` to stay consistent with this file.
- Keep this file concise and operational: commands, entrypoints, invariants, and safety rules only.
